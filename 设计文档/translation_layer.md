# Translation Layer

## 基本设计

Translation Layer的设计来源于FTL（Flash Translation Layer），但是在功能和目的上都与FTL有很大的不同。在了解Translation Layer之前，我们需要先介绍FTL。



## 层次结构



## 主要功能

### 写入Cache

写入Cache使用文件系统内存缓存文件的写入命令和数据，然后之后再将其推送到持久化存储中。由于应用程序不必等待I/O真实地将其数据写入物理存储中，所以通过写入Cache可以提高系统性能。

由于磁盘

### 坏块管理



### 纠错编码

纠错编码算法是传输过程中发生错误后能在接收端自行发现并纠正的码。早期被广泛应用于通信领域，在发送端完成数据编码，接收端完成数据译码，保证数据的可靠传输。NAND Flash作为一种广泛使用的存储介质，容易受到PE次数、数据保存时间、温度和Cell间干扰等因素的影响，数据写入后再读出无法保证绝对的正确性，因此需要ECC算法做数据恢复。合适的编码算法不仅保证了数据的正确性，还可以延长Flash 介质的寿命。

在这里，我们期望设计一种自适应的Flash纠错编码，达到稳定性和性能的平衡。

我们调研了常用的编码算法，最终采用并实现了两种常用的编码方式，并根据Flash介质的使用情况，智能地选择相应的编码方式，从而达到我们预设的期望。在存储数据期间不会验证数据，但是在请求数据时会测试是否有错误。如果需要的话，在检测之后会进行纠错阶段，如果错误超过了纠错能力，就会将读取的数据块标记为坏块。

**CRC32**

CRC的全称是循环冗余校验。CRC检测能力极强，开销小，易于用编码器及检测电路实现。从其检测能力来看，他所不能发现错误的几率仅为0.0047%以下。从性能上和开销上考虑，均远远优于奇偶校验及算数和校验等方式。因此，在数据存储和数据通讯领域，CRC可谓是无处不在。CRC按照编码后的长度可以分为CRC8、CRC16、CRC32等。我们使用的是CRC32，即编码后的长度是32bit。

**ECC**

ECC可以检查读取或传输的数据是否有错误，并在发现错误后立即对其进行纠正。ECC与奇偶校验类似，除了它在检测到错误后立即纠正错误。ECC在数据存储和网络传输硬件领域变得越来越普遍，尤其是随着数据速率和相应错误的增加。

**自适应纠错编码**

CRC32是一个性能极高的校验算法，我们在写入数据时默认采用CRC32的方式在Reserved Region更新校验信息。

使用ECC的条件：

* 坏块比例达到0.02
* 使用寿命达到2/3
* 出现坏块时间周期足够小

**可拓展性**

每一个Page 4096KB的写入，我们会为其分配128bit的空间用于存储纠错校验信息。128bit记录了使用的校验算法，写入Page位置

## 功能实现

### WriteCache

#### 相关数据结构

**WriteBuf**

* address
* data

写缓存中缓存的数据项，标识一次写记录。

**WriteCache**

* capacity
* cache
* table
* sync

写缓存的容量默认为32，cache用于存储WriteBuf，table哈希表用于标识一条写记录是否存在，避免过多重复的查找。sync标识写缓存的使用情况，是否需要将写缓存中的数据同步到物理存储中。

#### 关键函数

**write**

在写缓存中插入一条写记录。

**read**

从写缓存中读取一条写记录。

**get_all**

读出写缓存中的所有写记录。

**recall_write**

撤回写缓存中的一条写记录，当发生擦写操作时，需要撤回相关page缓存在写缓存中的写记录，避免不必要的写入。

**need_sync**

返回写缓存使用情况，如果写缓存满了，需要将缓存中的写记录持久化到物理存储中。

**sync**

持久化写缓存中的内容后调用，清空写缓存。

### CheckCenter

#### 相关数据结构

**CheckType**

* Crc32
* Ecc

用于区分Page所使用的纠错校验算法

**CheckCenter**

提供一系列纠错校验算法的使用和相关使用函数

#### 关键函数

**check**

输入page的数据，以及对应的signature，返回校验结果，如果校验发现有数据位发生错误，且错误在可接受修正范围内，返回修复后的数据/

**sign**

输入page的数据，以及纠错校验所需要使用的算法，生成对应的128bit signature。

**extract_address**

输入signature，返回这个signature所属page的address。

### TranlsationLayer

#### 相关数据结构



#### 关键函数



