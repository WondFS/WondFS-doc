# F2FS中垃圾回收优化

## Reducing garbage collection overhead of log-structured file systems with GC journaling

### 【问题描述】
在F2FS垃圾回收后，需要触发一次checkpoint用于更新文件系统状态，才能使得被更新的单元节（Section）才能投入重新使用。否则，系统发生crash后，倘若checkpoint利用到已回收的数据块进行系统恢复，则系统将一直崩溃。此外，checkpoint开销极大，每次垃圾回收都要触发checkpoint，开销巨大。

### 【解决方案】
本文提出一种GC journaling机制用于代替垃圾回收过程中Checkpointing。GCJ使用一个日志空间来记录GC移动的块的所有信息。使用日志，可以保证文件系统的一致性，而无需在系统崩溃时进行检查点。通过消除垃圾收集期间的检查点，进而可以显著降低垃圾收集延迟。如图所示，在迁移victim block时写入Journal entries。

![image](https://user-images.githubusercontent.com/33679152/170817892-74aab184-7554-46b3-8b4d-1d4e9f5444eb.png)

## Reinforcement Learning based Background Segment Cleaning for Log-structured File System on Mobile Devices

### 【摘要】
随着移动设备采用日志结构文件系统，后台段清理对系统性能和存储寿命的影响变得十分显著。 激进的后台段清理方案会产生过多的块迁移，损害NAND存储设备的耐用性，而常规的懒惰策略无法为后续的I/O请求回收足够的段，从而导致前台段清理的发生并延长I/O延迟。 在本文中，提出了一种基于强化学习的方法来平衡权衡，通过学习 I/O 工作负载的行为和逻辑地址空间的状态，所提出的方法可以自适应地将前台段清理的频率平均降低 68.57%，并且比现有方法减少 71.10% 的块迁移次数。

### 【背景】
通过以仅附加日志记录方式执行写入，LFS 设法减轻随机写入对系统性能的不利影响 [19]。 然而，这种异地更新方式会产生需要不时回收的无效逻辑块。 因此，段清理是 LFS 的一个重要组成部分。

LFS 维护两种类型的段清理，前台和后台段清理。前台段清理由写请求触发，在此期间LFS需要挂起写请求。结果，延长了用户 I/O 延迟。由于移动设备对系统响应的高度敏感，缓慢的 I/O 延迟可能会影响用户体验。为了缓解这个问题，定期进行后台段清理活动。挑战在于如何设置频率。激进的频率会导致过度的块迁移，这会产生额外的程序操作并损害闪存的耐用性。相比之下，懒惰的频率无法适应不同的工作负载行为。在密集的工作负载环境下，逻辑地址空间（LAS）中剩余的空闲空间可能不足以容纳后续的I/O请求，从而导致前台段清理的发生。在这种情况下，需要在移动设备的系统性能和存储寿命之间做出适当的权衡。

在这项工作中，提出了一种基于强化学习协助的后台段清理策略（RLBC）。 通过结合所有相关因素，RLBC 设法根据 逻辑地址空间LAS 的不同状态和工作负载行为自适应地做出清理决策。通过这种方式，可以平衡系统性能和闪存寿命之间的权衡。实验结果表明，与现有方法相比，所提出的方法可以有效地将前台段清理次数平均减少68.57%，同时将后台段清理中的块迁移次数减少71.10%。

### 【核心架构】
![image](https://user-images.githubusercontent.com/33679152/170818011-c2083bb1-697d-4d05-bcb5-38b1c47cc927.png)

图 5 描述了所提出方法的架构。在每个迭代步骤中，①RL 模型从环境（I/O 堆栈）中收集写入信息和 LAS 状态。有了这些信息，代理（BC 调度程序）可以识别 Q-table 中的当前状态。然后，它决定对 LFS 执行探索（随机选择一个未学习的动作）或利用（选择一个学习到的当前状态在 Q 表中具有最大 Q 值的动作）②③以在选定的时间间隔后实现后台段清理。后台段清理完成后，④agent收集块迁移数和回收块数。然后，agent根据更新后的 LAS 状态和写入信息再次感知状态。值得一提的是，每次清理后台段后，agent都会等待一段时间收集前台清理的触发时间，并根据公式3计算奖励。⑤最后将将来更新到Q-table中对应的条目中。

后台段清理是 LFS 的一个关键问题。激进的后台段清理会产生过度的块迁移，这会严重缩短移动闪存的使用寿命。 相比之下，后台片段清理不足可能会导致前台片段清理的发生，影响用户在移动设备上的体验。 为了解决这个问题，这项工作提出了 RLBC，这是一种基于强化学习的方法，可以自适应地决定何时触发后台片段清理。 评估结果表明，RLBC 设法减少了块迁移的次数，同时有效地减少了前景段清洗的发生。 以这种方式，系统性能随着存储寿命的延长而提高。


